<% current_controller = Rails.application.routes.recognize_path(request.env['PATH_INFO'])[:controller] %>

<% included = ProductRegistry.where(registry_id: @registry.id).map{ |r| r.product_id }.sort if current_controller == 'registries' %>

<!-- Search form for products -->
<% if current_controller == "registries" %>
  <h3>Search registries</h3>
<% else %>
  <h3>Search products</h3>
<% end %>
<%= search_form_for @q, :url => { :action => 'search', :controller => current_controller } do |f| %>
  <%= f.text_field :name_cont, :placeholder => 'Product name' %>
  <%= f.text_field :description_cont, :placeholder => 'Product description' %>
  <%= f.text_field :price_gteq, :placeholder => 'Minimum price' %>
  <%= f.text_field :price_lteq, :placeholder => 'Maximum price' %>
  <%= f.text_field :merchant_cont, :placeholder => 'Product provider' %>
  <%= f.submit :class => "btn btn-default btn-sm" %>
<% end %>

<!-- Pagination -->
<%= will_paginate @products %>

<!-- Product listings -->
<div class="free-wall">
  <div class="card-deck">
    <% @products.each do |p| %>
      <% if current_controller == 'registries' %>
        <% pr = ProductRegistry.find_by(registry_id: @registry.id, product_id: p.id) %>
        <% pr.nil? ? pr_quant = 0 : pr_quant = pr.quantity %>
        <% pr.nil? ? pr_purch = 0 : pr_purch = pr.purchased %>
      <% end %>
      <div class="card product-cards box-shadow--4dp">
        <!-- WHEN PRODUCT INFORMATION IS PULLED IN, IMAGE SOURCE SHOULD BE TIED TO PRODUCT -->
        <img class="card-img-top" src="http://www.wired.com/wp-content/uploads/2015/06/Oculus-Rift-2-1024x576.jpg" alt="Oculus Rift" style="width:100%">
        <div class="card-block card-text">
          <span class="card-text">
            <h3 style="text-align:center"><b><u><%= p.name %></u></b></h3>
            <p><%= p.description %></p>
          </span>
          <p style="color:green"><b><%= number_to_currency(p.price) %></b></p>
          <p style="color:green"><i>Contribution to honeymoon fund: <b><%= number_to_currency(p.fund) %></b></i></p>
          <% if current_controller == 'registries' %>
            <% if pr.nil? %><p style="height:18px;"></p><% else %><div id=<%= "remaining-#{p.id}" %>><p style="height:18px"><i><%= [pr_quant - pr_purch, 0].max %> more needed out of <%= pr_quant %></i></p></div><% end %>
          <% end %>
          <% if user_signed_in? && current_controller == 'registries' && @registry.administrators.include?(current_user) %>
            <%= simple_form_for "product_registry", url: add_remove_product_path, html: { method: :post }, :remote => true do |f| %>
              <div class="col-md-1" style="width:25px; border-radius:10px"><%= f.input_field :quantity, :style => "width:25px", :value => ProductRegistry.exists?(product_id: p.id, registry_id: @registry.id) ? ProductRegistry.find_by(product_id: p.id, registry_id: @registry.id).quantity : "", :id => "quantity-#{p.id}" %></div>
              <%= f.hidden_field :product_id, :value => p.id %>
              <%= f.hidden_field :registry_id, :value => @registry.id %>

              <div class="col-md-2"><%= f.submit included.index(p.id).nil? ? "Add to Registry" : "Remove from Registry", :style => "width:175px", :class => included.index(p.id).nil? ? "btn-add-product" : "btn-remove-product", id: "add-remove-button-#{p.id}" %></div>
              <br><br>
            <% end %>
          <% end %>
          <% if user_signed_in?  && current_controller == 'registries' %>
            <% if pr_quant - pr_purch > 0 %>
              <img type="button" class="btn btn-lg" data-toggle="modal" data-target=<%= "#add-to-cart-#{p.id}-modal" %> src="/assets/ShoppingCartAdd.png" height="60" style="padding: 0px 0px 0px 0px;" id=<%= "add-cart-#{p.id}" %>> or <i><%= link_to "Skip the cart", nonuser_checkout_path(:product_id => p.id, :registry_id => @registry.id), :id => "checkout-#{p.id}", method: :post, remote: true %></i>
              <script>
                $('<%= "#checkout-#{p.id}" %>').click(function(){
                  window.open('<%= p.affiliate_link %>');
                  });
              </script>
            <% else %>
              <img type="button" class="btn btn-lg" disabled='disabled' data-toggle="modal" data-target=<%= "#add-to-cart-#{p.id}" %> src="/assets/ShoppingCartAdd.png" height="60" style="padding: 0px 0px 0px 0px;opacity:0" id=<%= "add-cart-#{p.id}" %>>
            <% end %>
          <% else %>
            <% if current_controller == 'registries' %>
              <% if pr_quant - pr_purch > 0 %>
                <i><%= link_to "Checkout without login", nonuser_checkout_path(:product_id => p.id, :registry_id => @registry.id), :id => "checkout-#{p.id}", method: :post, remote: true %></i>
                <script>
                  $('<%= "#checkout-#{p.id}" %>').click(function(){
                    window.open('<%= p.affiliate_link %>');
                    });
                </script>
              <% else %>
                <i><%= link_to_if (pr_quant - pr_purch > 0), "" %></i>
                <!--<a href="#" disabled='true' style="opacity:0", id=<%= "checkout-#{p.id}" %>><%= nonuser_checkout_path(:product_id => p.id, :registry_id => @registry.id) %></a>-->
              <% end %>
            <% end %>
          <% end %>
          <br><br>
        </div>
      </div>
    <% end %>
  </div>
</div>