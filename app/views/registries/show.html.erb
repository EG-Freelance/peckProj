<p id="notice"><%= notice %></p>

<% included = ProductRegistry.where(registry_id: @registry.id).map{ |r| r.product_id }.sort %>

<% progress_array = ProductRegistry.where(registry_id: @registry.id).map { |pr| [pr.product.fund.to_f, pr.purchased] } %>
<% progress_array.empty? ? progress = 0 : progress = progress_array.map{ |p| p.inject(:*) }.inject(:+)/@registry.goal*100 %>

<!-- Invite more users if the current user is the owner -->
<% if user_signed_in? %>
  <% if current_user.owned_registries.map{ |r| r.id }.index(@registry.id) != nil %>
    <button type="button" class="btn btn-lg btn-signup" data-toggle="modal" data-target="#invite">Invite more administrators</button>
  <% end %>
<% end %>

<h1 class='regisli-font reg-title' style='text-align:center'><%= @registry.name %></h1>

<p>Honeymoon Fund Progress</p>
<div id="progressbar">
  <div style="text-align:center"><%= progress.to_i %>%</div>
</div>

<!-- Search form for products -->
<%= search_form_for @q, :url => { :action => 'search', :controller => 'registries' } do |f| %>
  <%= f.text_field :name_cont, :placeholder => 'Product name' %>
  <%= f.text_field :description_cont, :placeholder => 'Product description' %>
  <%= f.text_field :price_gteq, :placeholder => 'Minimum price' %>
  <%= f.text_field :price_lteq, :placeholder => 'Maximum price' %>
  <%= f.submit %>
<% end %>

<!-- Product listings -->
<div class="free-wall">
  <div class="card-deck">
    <% @products.each do |p| %>
      <div class="card product-cards box-shadow--4dp">
        <img class="card-img-top" src="http://www.wired.com/wp-content/uploads/2015/06/Oculus-Rift-2-1024x576.jpg" alt="Oculus Rift" style="width:100%">
        <div class="card-block card-text">
          <h3 class="card-title" style="text-align:center"><%= p.name %></h3>
          <p class="card-text"><%= p.description %></p>
          <p style="color:green"><b><%= number_to_currency(p.price) %></b></p>
          <p style="color:green"><i>Contribution to honeymoon fund: <b><%= number_to_currency(p.fund) %></b></i></p>
          <%= simple_form_for "product_registry", url: add_remove_product_path, html: { method: :post }, :remote => true do |f| %>
            <div class="col-md-1" style="width:25px; border-radius:10px"><%= f.input_field :quantity, :style => "width:25px", :value => ProductRegistry.exists?(product_id: p.id, registry_id: @registry.id) ? ProductRegistry.find_by(product_id: p.id, registry_id: @registry.id).quantity : "", :id => "quantity-#{p.id}" %></div>
            <%= f.hidden_field :product_id, :value => p.id %>
            <%= f.hidden_field :registry_id, :value => @registry.id %>
          <div class="col-md-2"><%= f.submit included.index(p.id).nil? ? "Add to Registry" : "Remove from Registry", :style => "width:175px", :class => included.index(p.id).nil? ? "btn-add-product" : "btn-remove-product", id: "add-remove-button-#{p.id}" %></div>
          <% end %>
          <br><br>
        </div>
      </div>
    <% end %>
  </div>
</div>

<%= link_to 'Back', registries_path %>

<!-- Invite Users Modal -->
<div id="invite" class="modal fade" role="dialog">
  <div class="modal-dialog">

    <!-- Modal content-->
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal">&times;</button>
        <h4 class="modal-title">Invite administrators</h4>
      </div>
      <div class="modal-body">
        <%= render 'devise/invitations/new' %>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
      </div>
    </div>

  </div>
</div>

<script>
  $('#invite-user').on('submit', function() {
    $('#invite').modal('hide');
  });
</script>

<script type="text/javascript">

  $('.card-deck').masonry({
    // options...
    itemSelector: '.card',
    fitwidth: true,
    percentPosition: true
  });
</script>

<script>
  $('#progressbar div').css('width', <%= progress.to_s %>+'%');
</script> 